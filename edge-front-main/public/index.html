<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EDGE LIF — Voice Chat</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c0f; --panel:#12141a; --muted:#9aa0a6; --text:#e6e9ef;
      --accent:#f97316; --accent2:#1d232f; --ok:#22c55e; --warn:#eab308; --err:#ef4444;
      --border:#262a33; --bubble:#1b2430; --bubble2:#22303b; --input:#0f1116;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Montserrat',system-ui,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(1200px 800px at 80% -50%, rgba(249,115,22,.10), transparent 60%),
                 radial-gradient(900px 500px at -10% 120%, rgba(34,197,94,.10), transparent 60%),
                 var(--bg);
      color:var(--text); overflow:hidden;
    }
    .wrap{height:100%; display:grid; grid-template-rows:auto auto 1fr auto auto; gap:14px; padding:16px 18px 14px}
    .logo{display:block; height:64px; margin:0 auto 2px; filter:drop-shadow(0 10px 30px rgba(0,0,0,.5))}
    .controls{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap}
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:var(--panel); color:var(--muted);
    }
    .badge.ok{color:#eaffef;border-color:#214f35;background:linear-gradient(180deg,#173425,#0f1b16)}
    .badge.speaking{color:#ffefe6;border-color:#5b3116;background:linear-gradient(180deg,#2e170e,#1b110c)}
    .badge.interrupt{color:#ffeaea;border-color:#6a1d1d;background:linear-gradient(180deg,#3a1616,#1f0e0e)}
    .pill{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      padding:10px 14px; border-radius:12px; display:flex; align-items:center; gap:10px;
    }
    .switch{display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--panel)}
    .switch input{width:18px;height:18px}
    .range{display:flex; align-items:center; gap:10px; border:1px solid var(--border); padding:8px 12px; border-radius:10px; background:var(--panel)}
    .range input{width:160px}
    .chat{
      background:var(--panel); border:1px solid var(--border); border-radius:14px;
      padding:12px; min-height:0; display:grid; grid-template-rows:1fr; overflow:hidden;
    }
    #log{overflow:auto; padding-right:8px; display:grid; gap:12px; align-content:start}
    .msg{max-width:80%; border-radius:12px; padding:12px 14px; line-height:1.55; white-space:pre-wrap}
    .user{justify-self:end; background:var(--bubble2)}
    .assistant{justify-self:start; background:var(--bubble)}
    .composer{display:grid; grid-template-columns:1fr auto; gap:12px; margin-top:4px}
    textarea{
      width:100%; background:var(--input); color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:12px 14px;
      resize:none; min-height:84px;
    }
    button.btn{
      background:var(--accent); color:white; border:0; border-radius:14px; padding:14px 18px;
      font-weight:800; cursor:pointer; box-shadow:0 6px 24px rgba(249,115,22,.3);
    }
    .footer{color:var(--muted); text-align:center; font-size:12px}
    .footer a{color:#92c5ff; text-decoration:none}

    /* --- Mascot styles --- */
    .mascot {
      position: fixed;
      left: 22px;
      bottom: 22px;
      width: 120px;
      height: 120px;
      border-radius: 18px;
      padding: 10px;
      background: linear-gradient(180deg, #0f1218, #0b0d12);
      border: 1px solid var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      transform: translateY(0);
      animation: bob 3.2s ease-in-out infinite;
      z-index: 10;
    }
    .mascot:hover{transform: translateY(-2px) scale(1.02)}
    .mascot img{max-width:100%; height:auto; display:block; filter: drop-shadow(0 8px 24px rgba(0,0,0,.35))}
    .mascot .status {
      position:absolute; right:10px; bottom:10px; width:12px; height:12px; border-radius:50%;
      box-shadow:0 0 10px currentColor;
      background: var(--muted);
    }
    /* status colors controlled by data-state */
    .mascot[data-state="idle"] .status{background:#64748b}
    .mascot[data-state="listening"] .status{background:var(--warn)}
    .mascot[data-state="speaking"] .status{background:var(--ok)}
    .mascot[data-state="error"] .status{background:var(--err)}
    @keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }

    /* keep it off very small screens */
    @media (max-width: 560px){
      .mascot{width:88px; height:88px; left:12px; bottom:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <img class="logo" src="/logo.png" alt="EDGE LIF" />

    <div class="controls">
      <button id="toggleVoice" class="btn pill">Start Voice</button>
      <span id="stateBadge" class="badge">Idle</span>
      <label class="switch">
        <input type="checkbox" id="speakSwitch" checked>
        <span>Speak replies</span>
      </label>
      <label class="range">
        <span>Rate</span>
        <input id="rate" type="range" min="0.7" max="1.6" step="0.05" value="1.0" />
      </label>
      <span class="badge">Tip: press <b>M</b> to toggle mic</span>
    </div>

    <div class="chat">
      <div id="log"></div>
    </div>

    <div class="composer">
      <textarea id="input" placeholder="Type a message…  (Enter to send, Shift+Enter for newline)"></textarea>
      <button id="send" class="btn">Send</button>
    </div>

    <div class="footer">
      Created by <a href="https://www.linkedin.com/in/awaiz-ahmed/" target="_blank" rel="noopener">Awaiz Ahmed</a>
    </div>
  </div>

  <!-- Mascot (click to start/stop voice) -->
  <div id="mascot" class="mascot" aria-label="Voice assistant">
    <img src="/assets/mascot.webp" alt="EDGE LIF Mascot" />
    <span class="status" aria-hidden="true"></span>
  </div>

  <script type="module" src="/api/chat.js"></script>

  <!-- Small helper to sync mascot with app state and toggle voice -->
  <script>
    const mascot = document.getElementById('mascot');
    const stateBadge = document.getElementById('stateBadge');
    const toggleBtn = document.getElementById('toggleVoice');

    // Click mascot => same as Start/Stop Voice
    mascot.addEventListener('click', () => toggleBtn?.click());

    // Reflect current state on the mascot’s status dot
    function syncMascotState(){
      const t = (stateBadge?.textContent || 'idle').trim().toLowerCase();
      // map a few common states
      let s = 'idle';
      if (t.includes('speak')) s = 'speaking';
      else if (t.includes('listen') || t.includes('record')) s = 'listening';
      else if (t.includes('error') || t.includes('fail')) s = 'error';
      mascot.dataset.state = s;
    }
    syncMascotState();

    // Watch for changes to the badge so the mascot stays in sync
    if (stateBadge){
      const mo = new M
